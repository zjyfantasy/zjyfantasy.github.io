<!DOCTYPE html>
<html lang="en">

<head>

	<title>多途径点</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<script src="./lib/fengmap.map.min.js"></script>
	<script src="./lib/fengmap.analyser.min.js"></script>
	<script src="./lib/fengmap.plugin.min.js"></script>
	<link rel="stylesheet" href="./style/fengmap.css">
	<script src="js/points.js"></script>

</head>

<body>
	<div class="navi-info"></div>
	<div id="fengmap"></div>
</body>
<script>

	// 定义全局map变量
	var map = null;

	var analyser = null;

	var interval = null;


	var request = {

		start: {
			level: 1,
			x: naviRealPoints[0].x,
			y: naviRealPoints[0].y,
			height: 3,
			url: './images/start.png',
			size: 32
		},
		dest: {
			level: 2,
			x: naviRealPoints[1].x,
			y: naviRealPoints[1].y,
			height: 3,
			url: './images/end.png',
			size: 32
		},


		viapoints: [
			{
				level: 3,
				x: 12619628.002493313, y: 2621885.4758256087,
				name: "朗姿"
			}, {
				level: 2,
				x: 12619634.314717708, y: 2621877.788336626,
				name: "面包新语"
			}, {
				level: 2,
				x: 12619603.076292844, y: 2621870.561755689,
				name: "冠军"
			}
		],
		toDoors: false,
		mode: fengmap.FMNaviMode.MODULE_SHORTEST,
		priority: fengmap.FMNaviPriority.PRIORITY_DEFAULT
	}

	var locationMarker = new fengmap.FMLocationMarker({
		x: request.start.x,
		y: request.start.y,
		url: './images/location2.png',
		level: request.start.level,
		size: 48,
		height: 1,
	})


	window.onload = function () {
		openMap();
	};


	function openMap() {

		map = new fengmap.FMMap({
			container: document.getElementById('fengmap'),
			mapID: '1321274646113083394',
			appName: '蜂鸟研发SDK_2_0',
			key: '57c7f309aca507497d028a9c00207cf8',
			visibleLevels: [1, 2, 3]
		});

		map.on("loaded", () => {
			locationMarker.addTo(map);
			testNavi();
		})


		function testNavi() {
			analyser = new fengmap.FMNaviAnalyser({ map: map }, () => {

				testNavigation();

			}, (error) => {
				console.log(error);
			});
		}

		//初始化导航参数
		function testNavigation() {

			addViapointMarker();

			var navigation = new fengmap.FMNavigation({
				map: map,
				followPosition: true,
				analyser: analyser,
				locationMarkerUrl: './images/location2.png',
				locationMarkerSize: 48,
				linePassed: true
			});


			navigation.setStartPoint(request.start);
			navigation.setDestPoint(request.dest);

			navigation.route({
				toDoors: request.toDoors,
				viapoints: request.viapoints,
				mode: request.mode,
				priority: request.mode.priority
			}, (result) => {

				navigation.overview({
					ratio: 1.5
				}, function () {

					navigation.drawNaviLine();
					updateLocation(realPoints, navigation);
				});
			}, (result) => {
				console.log("failed", result);
			});


			navigation.on('walking', (data) => {

				setLocationMakerPosition(data.point, data.angle);
				updateUI(navigation.naviResult.subs[data.index].instruction.zh + ' 距离终点：' + data.remain.toFixed(2) + '米');

			});

		}


		/**
		 * 设置定位标注点位置信息
		 * */

		function setLocationMakerPosition(coord, angle) {

			if (angle) {

				// 定位点方向始终与路径线保持平行
				locationMarker.rotateTo({
					heading: -angle,
					duration: 0.5
				});

			}

			//移动locationMarker
			var data = {
				x: coord.x,
				y: coord.y,
				level: coord.level,
				duration: 0.5,
				animate: true
			};

			//移动locationMarker
			locationMarker.moveTo(data);
		}



		var level = map.getLevel();

		function updateLocation(points, navigation) {

			var index = 0;

			interval = setInterval(() => {
				navigation.locateNoConstraint(points[index]);
				index++;
				if (index >= points.length) {
					clearInterval(interval);
				}
			}, 500)
		}
	}


	/* 导航路径文字描述 */
	function updateUI(msg) {
		var infoDiv = document.body.getElementsByClassName('navi-info')[0];
		infoDiv.innerText = msg;
	}

	function addViapointMarker() {


		var index = 0;

		request.viapoints.forEach((item) => {

			var marker = new fengmap.FMTextMarker({
				x: item.x,
				y: item.y,
				text: '' + index + '-' + item.name,    // 文本内容
				fillColor: "255,255,255",    //文本标注填充色
				fontsize: 12,            // 文本标注字体大小
				strokeColor: "47,126,222", // 文本标注边线颜色
				plateColor: "47,126,222",     // 背景色
				plateStrokeColor: "47,126,222",// 背景变宽色
				textAlign: fengmap.FMTextAlign.Center,
				anchor: fengmap.FMMarkerAnchor.BOTTOM,
				collision: false
			});

			// Marker添加到楼层
			var floor = map.getFloor(item.level);
			marker.addTo(floor);

			index++;

		});
	}

	function stopInterval() {
		if (interval) clearInterval(interval);
	}

</script>

</html>